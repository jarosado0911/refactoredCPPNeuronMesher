name: SonarCloud Analysis

on:
  workflow_dispatch:  # manually triggered
  push:
    branches: [main]

env:
  BUILD_TYPE: Debug

jobs:
  sonarcloud:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          lcov \
          gcovr \
          cmake \
          build-essential

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Configure CMake (to generate compile_commands.json)
      run: |
        cmake -B build \
              -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
              -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    - name: Generate dummy C++ coverage (optional)
      run: |
        gcovr -r . --sonarqube coverage.xml || echo "Skipping coverage"

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      with:
        args: >
          -Dsonar.projectKey=jarosado0911_refactoredCPPNeuronMesher
          -Dsonar.organization=jarosado0911
          -Dsonar.host.url=https://sonarcloud.io
          -Dsonar.cfamily.compile-commands=build/compile_commands.json
          -Dsonar.coverageReportPaths=coverage.xml
          -Dsonar.exclusions=**/*.html,docs/doxygen/**,src/tinyfiledialogs.c,src/viewercpp/**
          -Dsonar.coverage.exclusions=coverage/**,src/bindings.cpp,python_package/test/test_bindings.py
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
